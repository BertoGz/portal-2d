<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal 2d (demo)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #eee;
            user-select: none;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            background-color: #222;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            outline: none;
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: none; /* Hidden by default, shown when paused */
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }

        #ui.paused {
            display: flex;
            pointer-events: auto;
        }

        /* Main Menu Overlay */
        #main-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #222;
            background: radial-gradient(circle, #333 0%, #111 100%);
        }

        #main-menu.hidden {
            display: none;
        }

        .menu-box {
            background: rgba(51, 51, 51, 0.9);
            padding: 50px;
            border-radius: 20px;
            border: 1px solid #555;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            text-align: center;
            min-width: 450px;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .pause-menu {
            background: #333;
            padding: 40px;
            border-radius: 16px;
            border: 1px solid #555;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
            min-width: 400px;
        }

        h1 { 
            margin: 0 0 10px 0; 
            font-size: 42px; 
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 800;
        }

        .subtitle {
            color: #aaa;
            font-size: 18px;
            margin-bottom: 30px;
            letter-spacing: 1px;
        }
        
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            text-align: left;
        }

        p { margin: 8px 0; font-size: 15px; opacity: 0.9; color: #ccc; }
        
        .key {
            display: inline-block;
            background: #eee;
            color: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            margin: 0 2px;
            box-shadow: 0 2px 0 #aaa;
        }

        button {
            background: #00A2FF;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
            margin-top: 20px;
            box-shadow: 0 4px 0 #0077CC;
        }

        button:hover {
            background: #33b5ff;
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #0077CC;
        }

        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0077CC;
        }

        .start-btn {
            background: #FF9900;
            box-shadow: 0 4px 0 #cc7a00;
        }

        .start-btn:hover {
            background: #ffad33;
            box-shadow: 0 6px 0 #cc7a00;
        }

        .start-btn:active {
            box-shadow: 0 2px 0 #cc7a00;
        }

        /* Editor Styles */
        #editor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #222;
            color: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        #editor-overlay.active {
            display: flex;
        }

        /* Top Menu Bar */
        #menubar {
            background: #333;
            padding: 0 10px;
            height: 40px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #444;
            user-select: none;
        }

        .menu-item {
            padding: 8px 15px;
            cursor: pointer;
            position: relative;
            font-size: 14px;
        }

        .menu-item:hover {
            background: #444;
        }

        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #333;
            border: 1px solid #444;
            min-width: 150px;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .menu-item:hover .dropdown {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            white-space: nowrap;
        }

        .dropdown-item:hover {
            background: #444;
        }

        /* Main Layout */
        #editor-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: 250px;
            background: #2a2a2a;
            border-right: 1px solid #444;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 10px;
        }

        .sidebar-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .sidebar-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #aaa;
            text-transform: uppercase;
        }

        /* Tools */
        .tool-group {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tool-btn {
            flex: 1;
            padding: 8px;
            background: #333;
            border: 1px solid #444;
            color: #ccc;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
        }

        .tool-btn:hover {
            background: #444;
        }

        .tool-btn.active {
            background: #00A2FF;
            color: white;
            border-color: #00A2FF;
        }

        /* Block Palette */
        .block-palette {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
            gap: 5px;
        }

        .palette-item {
            width: 32px;
            height: 32px;
            background: #444;
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
        }

        .palette-item.active {
            border-color: #fff;
            box-shadow: 0 0 5px rgba(255,255,255,0.5);
        }
        
        .palette-item[data-type="1"] { background: #888; } /* Regular Wall */
        .palette-item[data-type="2"] { background: #00A2FF; } /* Water */
        .palette-item[data-type="3"] { background: #FF5500; } /* Fire */
        
        /* Entities */
        .entity-item {
            display: flex;
            align-items: center;
            padding: 5px;
            cursor: pointer;
            border: 1px solid transparent;
            margin-bottom: 2px;
        }
        
        .entity-item:hover { background: #333; }
        .entity-item.active { border-color: #00A2FF; background: #333; }
        .entity-icon { width: 16px; height: 16px; margin-right: 8px; border-radius: 50%; }

        /* Layers */
        .layer-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 5px;
            background: #333;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .layer-item.active {
            background: #444;
            border-left-color: #00A2FF;
        }

        .layer-visibility {
            width: 20px;
            text-align: center;
            margin-right: 5px;
            cursor: pointer;
            color: #aaa;
        }
        
        .layer-visibility:hover { color: #fff; }

        /* Canvas Area */
        #canvas-container {
            flex: 1;
            background: #111;
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }

        #editor-canvas {
            display: block;
            transform-origin: 0 0;
            image-rendering: pixelated; /* Crisp pixels for editor */
        }
        
        /* Status Bar */
        #statusbar {
            height: 25px;
            background: #333;
            border-top: 1px solid #444;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            color: #aaa;
            justify-content: space-between;
        }

        /* Back to Game Button */
        #back-to-game-btn {
            background: #FF5500;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        #back-to-game-btn:hover {
            background: #ff7733;
        }
    </style>
  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();const d={GRAVITY:.2,MOVE_SPEED:3,MAX_SPEED:25,HIGH_SPEED_GROUND_RETENTION:.98,LOW_SPEED_GROUND_RETENTION:.7,MIN_AIR_ACCEL:.05,MAX_AIR_ACCEL:.2,SUBSTEPS:16,PORTAL_WIDTH:60,PLAYER_SIZE:24,PORTAL_ANCHOR_DISTANCE:30,ZOOM:1.5,CAM_LERP:.05,CAM_LOOKAHEAD:.3,CAM_BOUNDARY_PADDING:200,PORTAL_REDIRECT:1,PORTAL_SUCTION:0,PORTAL_SUCTION_SPEED_SCALE:0,PORTAL_SUCTION_PREDICT_TIME:1,MAX_CONTROL_LOCK_TIME:.5,CONTROL_LOCK_SPEED_THRESHOLD:4,BLOCK_SIZE:32,EDITOR_GRID_COLOR:"rgba(255, 255, 255, 0.1)",EDITOR_BG_COLOR:"#111"},R=1920,I=1080;class u{constructor(t,e){this.x=t,this.y=e}add(t){return new u(this.x+t.x,this.y+t.y)}sub(t){return new u(this.x-t.x,this.y-t.y)}mult(t){return new u(this.x*t,this.y*t)}mag(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){let t=this.mag();return t===0?new u(0,0):new u(this.x/t,this.y/t)}rotate(t){return new u(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}dot(t){return this.x*t.x+this.y*t.y}}function st(n,t,e){let s=null,i=1/0,r=null,o=n.add(t.mult(3e3));for(let a of e){const c=[{p1:new u(a.x,a.y),p2:new u(a.x+a.w,a.y),n:new u(0,-1)},{p1:new u(a.x,a.y+a.h),p2:new u(a.x+a.w,a.y+a.h),n:new u(0,1)},{p1:new u(a.x,a.y),p2:new u(a.x,a.y+a.h),n:new u(-1,0)},{p1:new u(a.x+a.w,a.y),p2:new u(a.x+a.w,a.y+a.h),n:new u(1,0)}];for(let l of c){const p=l.p1.x,w=l.p1.y,g=l.p2.x,m=l.p2.y,y=n.x,f=n.y,v=o.x,x=o.y,E=(p-g)*(f-x)-(w-m)*(y-v);if(E===0)continue;const L=((p-y)*(f-x)-(w-f)*(y-v))/E,S=-((p-g)*(w-f)-(w-m)*(p-y))/E;if(L>=0&&L<=1&&S>=0&&S<=1){const b=p+L*(g-p),O=w+L*(m-w),M=Math.sqrt((b-n.x)**2+(O-n.y)**2);M<i&&(i=M,s=new u(b,O),r=l.n)}}}return s?{pos:s,normal:r,dist:i}:null}function it(n,t){for(let e of t)if(n.x>=e.x&&n.x<=e.x+e.w&&n.y>=e.y&&n.y<=e.y+e.h)return!0;return!1}class ht{static calculate(t,e,s,i=200){let r=1/0,o=1/0,a=-1/0,c=-1/0;for(let l of t)r=Math.min(r,l.x),o=Math.min(o,l.y),a=Math.max(a,l.x+l.w),c=Math.max(c,l.y+l.h);if(e)for(let l of e)l.active&&l.pos&&(r=Math.min(r,l.pos.x),o=Math.min(o,l.pos.y),a=Math.max(a,l.pos.x),c=Math.max(c,l.pos.y));if(s&&s.getCenter){const l=s.getCenter();r=Math.min(r,l.x),o=Math.min(o,l.y),a=Math.max(a,l.x),c=Math.max(c,l.y)}return!isFinite(r)||!isFinite(o)||!isFinite(a)||!isFinite(c)?{minX:0,minY:0,maxX:1920,maxY:1080,width:1920,height:1080}:(r-=i,o-=i,a+=i,c+=i,{minX:r,minY:o,maxX:a,maxY:c,width:a-r,height:c-o})}}class ot{constructor(t,e,s){this.pos=new u(t,e),this.cameraVector=new u(t,e),this.lerpedPlayerPos=new u(t,e);const i=s.height/I;this.zoom=d.ZOOM*i}follow(t,e,s,i,r,o,a=null){this.lerpedPlayerPos.x+=(t.x-this.lerpedPlayerPos.x)*.15,this.lerpedPlayerPos.y+=(t.y-this.lerpedPlayerPos.y)*.15;let l,p;const w=s.height/I;let g=d.ZOOM*w;if(o&&r&&r[0].active&&r[1].active){const f=r[0].pos,v=r[1].pos,x=t,E=Math.min(f.x,v.x,x.x),L=Math.max(f.x,v.x,x.x),S=Math.min(f.y,v.y,x.y),b=Math.max(f.y,v.y,x.y);l=(E+L)/2,p=(S+b)/2;const O=d.PORTAL_WIDTH,M=d.PLAYER_SIZE,A=50,P=200,z=Math.max(P,L-E+Math.max(O,M)+A*2),$=Math.max(P,b-S+Math.max(O,M)+A*2),V=s.width/z,at=s.height/$,lt=d.ZOOM*w,ct=.5*w;g=Math.max(ct,Math.min(lt,Math.min(V,at)))}else{let f=s.width/2,v=s.height/2,x=(e.x-f)/this.zoom,E=(e.y-v)/this.zoom;const L=s.width/s.height;E*=L*2.2;let S=this.cameraVector.x+x,b=this.cameraVector.y+E;const O=d.CAM_LOOKAHEAD,M=1-O,A=O;let P=0,z=0,$=0;const V=M+A+P;l=(this.lerpedPlayerPos.x*M+S*A+z*P)/V,p=(this.lerpedPlayerPos.y*M+b*A+$*P)/V}this.cameraVector.x+=(l-this.cameraVector.x)*d.CAM_LERP,this.cameraVector.y+=(p-this.cameraVector.y)*d.CAM_LERP;let m=s.width/this.zoom/2,y=s.height/this.zoom/2;a?(this.cameraVector.x=Math.max(a.minX+m,Math.min(a.maxX-m,this.cameraVector.x)),this.cameraVector.y=Math.max(a.minY+y,Math.min(a.maxY-y,this.cameraVector.y))):(this.cameraVector.x=Math.max(m,Math.min(R-m,this.cameraVector.x)),this.cameraVector.y=Math.max(y,Math.min(I-y,this.cameraVector.y))),this.pos.x+=(this.cameraVector.x-this.pos.x)*d.CAM_LERP,this.pos.y+=(this.cameraVector.y-this.pos.y)*d.CAM_LERP,this.zoom+=(g-this.zoom)*.05}apply(t,e){t.translate(e.width/2,e.height/2),t.scale(this.zoom,this.zoom),t.translate(-this.pos.x,-this.pos.y)}screenToWorld(t,e){let s=e.width/2,i=e.height/2;return new u((t.x-s)/this.zoom+this.pos.x,(t.y-i)/this.zoom+this.pos.y)}}class U{constructor(t,e){this.id=t,this.color=e,this.active=!1,this.pos=new u(0,0),this.normal=new u(0,0),this.width=d.PORTAL_WIDTH}place(t,e){this.active=!0,this.pos=t,this.normal=e}getAngle(){return Math.atan2(this.normal.y,this.normal.x)}}class dt{constructor(t,e,s){this.pos=new u(t,e),this.vel=new u(0,0),this.size=s}getCenter(){return new u(this.pos.x+this.size/2,this.pos.y+this.size/2)}applyGravity(t){this.vel.y+=t}integrate(t){this.pos.x+=this.vel.x*t,this.pos.y+=this.vel.y*t}clampVelocity(t){this.vel.x=Math.max(-t,Math.min(t,this.vel.x)),this.vel.y=Math.max(-t,Math.min(t,this.vel.y))}checkCollision(t){if(this.pos.x<t.x+t.w&&this.pos.x+this.size>t.x&&this.pos.y<t.y+t.h&&this.pos.y+this.size>t.y){const e=t.x+t.w-this.pos.x,s=this.pos.x+this.size-t.x,i=t.y+t.h-this.pos.y,r=this.pos.y+this.size-t.y,o=Math.min(e,s,i,r);return{collided:!0,overlap:o,side:o===i?"top":o===r?"bottom":o===e?"right":"left",wall:t}}return null}resolveCollision(t){const e=this.checkCollision(t);if(!e)return null;const{side:s}=e;return s==="top"?(this.pos.y=t.y+t.h,this.vel.y=0,{side:"top",grounded:!1}):s==="bottom"?(this.pos.y=t.y-this.size,this.vel.y=0,{side:"bottom",grounded:!0}):s==="right"?(this.pos.x=t.x+t.w,this.vel.x=0,{side:"right",grounded:!1}):s==="left"?(this.pos.x=t.x-this.size,this.vel.x=0,{side:"left",grounded:!1}):null}applyFriction(t,e="x"){(e==="x"||e==="both")&&(this.vel.x*=t),(e==="y"||e==="both")&&(this.vel.y*=t)}applyAcceleration(t,e){const s=t.mult(e);this.vel=this.vel.add(s)}setVelocity(t,e){this.vel.x=t,this.vel.y=e}addVelocity(t,e){this.vel.x+=t,this.vel.y+=e}}class H{constructor(){this.moveX=0,this.jump=!1,this.shootBluePortal=!1,this.shootOrangePortal=!1,this.mouseX=0,this.mouseY=0,this.spaceHeld=!1}static fromRawInput(t){const e=new H;let s=0;return t.keys.a&&(s-=1),t.keys.d&&(s+=1),e.moveX=s,e.jump=t.keys.w||!1,e.shootBluePortal=t.keys.q||!1,e.shootOrangePortal=t.keys.e||!1,e.mouseX=t.screenMouse.x,e.mouseY=t.screenMouse.y,e.spaceHeld=t.keys[" "]||!1,e}serialize(){return{moveX:this.moveX,jump:this.jump,shootBluePortal:this.shootBluePortal,shootOrangePortal:this.shootOrangePortal,mouseX:this.mouseX,mouseY:this.mouseY,spaceHeld:this.spaceHeld}}static deserialize(t){const e=new H;return e.moveX=t.moveX,e.jump=t.jump,e.shootBluePortal=t.shootBluePortal,e.shootOrangePortal=t.shootOrangePortal,e.mouseX=t.mouseX,e.mouseY=t.mouseY,e.spaceHeld=t.spaceHeld,e}hasInput(){return this.moveX!==0||this.jump||this.shootBluePortal||this.shootOrangePortal}}class nt{constructor(t,e){this.body=new dt(t,e,d.PLAYER_SIZE),this.grounded=!1,this.portalCooldown=0,this.controlLockTimer=0,Object.defineProperty(this,"pos",{get:()=>this.body.pos,set:s=>{this.body.pos=s}}),Object.defineProperty(this,"vel",{get:()=>this.body.vel,set:s=>{this.body.vel=s}}),Object.defineProperty(this,"size",{get:()=>this.body.size})}getCenter(){return this.body.getCenter()}getGhostPos(t){if(!t||!t[0].active||!t[1].active)return null;const e=this.getCenter();let s=null,i=null,r=0;const o=450,a=e.sub(t[0].pos).mag(),c=e.sub(t[1].pos).mag();if(a<o?(s=t[0],i=t[1],r=a):c<o&&(s=t[1],i=t[0],r=c),s&&i){const l=new u(-s.normal.y,s.normal.x),p=new u(-i.normal.y,i.normal.x);let w=e.sub(s.pos);const g=w.dot(s.normal),m=w.dot(l),y=i.normal.mult(-g),f=p.mult(m);let v=y.add(f),x=Math.max(0,1-r/o);return x=x*x,{pos:i.pos.add(v),strength:x}}return null}update(t,e,s){new u(this.vel.x,this.vel.y),this.controlLockTimer>0&&this.controlLockTimer--;let i=0;this.controlLockTimer<=0&&(i=t.moveX);const r=Math.abs(this.vel.x),o=Math.min(1,r/d.MAX_SPEED);let a;if(this.grounded&&(a=d.LOW_SPEED_GROUND_RETENTION+(d.HIGH_SPEED_GROUND_RETENTION-d.LOW_SPEED_GROUND_RETENTION)*o),this.grounded&&this.body.applyFriction(a,"x"),this.body.applyGravity(d.GRAVITY),i!==0){const l=d.LOW_SPEED_GROUND_RETENTION,p=d.MOVE_SPEED*(1-l);let w;this.grounded||(w=d.MAX_AIR_ACCEL-(d.MAX_AIR_ACCEL-d.MIN_AIR_ACCEL)*o);const g=this.grounded?p:w,m=d.MOVE_SPEED;let y=this.vel.x*i,f=m-y;if(f>0){let v=Math.min(g,f);this.vel.x+=v*i}}t.jump&&this.grounded&&(this.body.setVelocity(this.body.vel.x,-8),this.grounded=!1),this.body.clampVelocity(d.MAX_SPEED),this.portalCooldown>0&&this.portalCooldown--,this.grounded=!1;const c=1/d.SUBSTEPS;for(let l=0;l<d.SUBSTEPS;l++)this.body.integrate(c),this.handlePortals(s),this.handleCollisions(e,s)}handleCollisions(t,e){for(let s of t){let i=!1;if(e&&e[0]&&e[1]&&e[0].active&&e[1].active)for(let o of e){const c=this.getCenter().sub(o.pos),l=new u(-o.normal.y,o.normal.x),p=c.dot(l);if(Math.abs(p)<o.width/2&&c.mag()<this.size*2&&o.pos.x>=s.x-1&&o.pos.x<=s.x+s.w+1&&o.pos.y>=s.y-1&&o.pos.y<=s.y+s.h+1){i=!0;break}}if(i)continue;const r=this.body.resolveCollision(s);r&&r.side==="bottom"&&(this.grounded=!0)}}handlePortals(t){if(this.portalCooldown>0)return;const e=t[0],s=t[1];!e.active||!s.active||(this.applyPortalSuction(e),this.applyPortalSuction(s),this.checkPortalIntersection(e,s),this.checkPortalIntersection(s,e))}applyPortalSuction(t){const e=this.getCenter(),s=this.vel.mag(),i=5,r=150;if(s<i)return;const o=d.PORTAL_SUCTION_PREDICT_TIME,a=e.add(this.vel.mult(o*60)),c=a.sub(t.pos).mag();if(c>=r||e.sub(t.pos).dot(t.normal)>=0)return;const w=this.vel.dot(t.normal),g=.3,m=-w/s;if(m>g){const y=new u(-t.normal.y,t.normal.x),f=a.sub(t.pos).dot(y),v=y.mult(-Math.sign(f)),x=(1-c/r)**2,E=Math.min(1,m/.7),L=s*d.PORTAL_SUCTION_SPEED_SCALE,S=d.PORTAL_SUCTION*x*E*L;this.vel=this.vel.add(v.mult(S))}}checkPortalIntersection(t,e){const i=this.getCenter().sub(t.pos),r=new u(-t.normal.y,t.normal.x),o=i.dot(t.normal),a=i.dot(r);if(Math.abs(a)<t.width/2){const c=this.pos.sub(this.vel.mult(1/d.SUBSTEPS));new u(c.x+this.size/2,c.y+this.size/2).sub(t.pos).dot(t.normal)>0&&o<=0&&this.teleport(t,e)}}teleport(t,e){const s=new u(-t.normal.y,t.normal.x),i=new u(-e.normal.y,e.normal.x),r=this.vel.dot(t.normal),o=this.vel.dot(s),a=e.normal.mult(-r),c=d.PORTAL_REDIRECT,l=i.mult(o*(1-c));let p=a.add(l);this.vel=p;let g=this.getCenter().sub(t.pos);g=g.mult(.2);const m=g.dot(t.normal),y=g.dot(s),f=e.normal.mult(-m),v=i.mult(y);let x=f.add(v),S=this.vel.mag()**2+0;S<0&&(S=0);const b=Math.sqrt(S);this.vel.mag()>0&&(this.vel=this.vel.normalize().mult(b));const O=3;this.vel.mag()<O&&(this.vel=e.normal.mult(O));let M=e.pos.add(x);if(!isFinite(M.x)||!isFinite(M.y))return;this.body.pos.x=M.x-this.size/2,this.body.pos.y=M.y-this.size/2,this.portalCooldown=2;const A=this.vel.mag(),P=Math.max(0,1-A/d.CONTROL_LOCK_SPEED_THRESHOLD),z=d.MAX_CONTROL_LOCK_TIME*P;this.controlLockTimer=Math.floor(z*60)}draw(t,e){this.drawBody(t,this.pos.x,this.pos.y);const s=this.getGhostPos(e);if(s){t.save();let i=Math.max(0,(s.strength-.7)*3.33);i>0&&(t.globalAlpha=.6*i,this.drawBody(t,s.pos.x-this.size/2,s.pos.y-this.size/2)),t.restore()}}drawBody(t,e,s){t.fillStyle="#fff",t.fillRect(e,s,this.size,this.size),t.fillStyle="#000";let i=this.vel.mag()>1?this.vel.normalize():new u(1,0);t.fillRect(e+this.size/2+i.x*6-2,s+this.size/2+i.y*6-2,4,4)}}class ut{constructor(t,e,s,i){this.pos=t,this.vel=e.mult(40),this.color=s,this.portalId=i,this.life=100,this.trail=[],this.trailLength=5}update(t,e,s,i){if(this.life--,this.life<=0)return!1;this.trail.unshift(new u(this.pos.x,this.pos.y)),this.trail.length>this.trailLength&&this.trail.pop();const r=this.pos.add(this.vel),o=st(this.pos,this.vel.normalize(),t);if(o){const a=Math.sqrt(Math.pow(o.pos.x-this.pos.x,2)+Math.pow(o.pos.y-this.pos.y,2)),c=this.vel.mag();if(a<=c){e(this.portalId,o.pos,o.normal),i&&i.playLand();for(let l=0;l<10;l++)s.push({pos:o.pos.add(o.normal.mult(2)),vel:new u((Math.random()-.5)*5+o.normal.x*5,(Math.random()-.5)*5+o.normal.y*5),life:30,color:this.color});return!1}}return this.pos=r,!0}draw(t){if(this.trail.length>1){t.beginPath(),t.moveTo(this.trail[0].x,this.trail[0].y);for(let e=1;e<this.trail.length;e++)t.lineTo(this.trail[e].x,this.trail[e].y);t.strokeStyle=this.color,t.lineWidth=3,t.lineCap="round",t.lineJoin="round",t.globalAlpha=.6,t.stroke(),t.globalAlpha=1}t.fillStyle="#fff",t.beginPath(),t.arc(this.pos.x,this.pos.y,4,0,Math.PI*2),t.fill()}}class yt{constructor(){this.inputState=new H,this.rawInput={keys:{},screenMouse:{x:0,y:0}},this.prevKeys={},this.onShootBluePortal=null,this.onShootOrangePortal=null}init(t){window.addEventListener("keydown",e=>{const s=e.key.toLowerCase();this.rawInput.keys[s]=!0,this.updateInputState()}),window.addEventListener("keyup",e=>{const s=e.key.toLowerCase();this.rawInput.keys[s]=!1,this.updateInputState()}),window.addEventListener("mousemove",e=>{const s=t.getBoundingClientRect();this.rawInput.screenMouse.x=Math.max(0,Math.min(t.width,e.clientX-s.left)),this.rawInput.screenMouse.y=Math.max(0,Math.min(t.height,e.clientY-s.top)),this.updateInputState()}),window.addEventListener("blur",()=>{this.rawInput.keys={},this.updateInputState()})}updateInputState(){this.inputState=H.fromRawInput(this.rawInput),this.inputState.shootBluePortal&&!this.prevKeys.q&&this.onShootBluePortal&&this.onShootBluePortal(),this.inputState.shootOrangePortal&&!this.prevKeys.e&&this.onShootOrangePortal&&this.onShootOrangePortal(),this.prevKeys={...this.rawInput.keys}}getInputState(){return this.inputState}isKeyPressed(t){return this.rawInput.keys[t.toLowerCase()]||!1}clearInput(){this.rawInput.keys={},this.updateInputState()}}class mt{constructor(t){this.canvas=t}instantiate(t){const e=t.blockSize||d.BLOCK_SIZE,s=[];let i={x:300,y:I-100};if(t.layers)for(const c of t.layers){if(!c.visible)continue;const l=new Map;for(const[p,w]of c.data){const[g,m]=p.split(",").map(Number);l.has(m)||l.set(m,new Map),l.get(m).set(g,w)}if(l.size){const p=this.mergeBlocks(l,e);s.push(...p)}}if(t.entities)for(const[c,l]of t.entities){const[p,w]=c.split(",").map(Number),g=p*e,m=w*e;l.type==="spawn"&&(i={x:g,y:m})}const r=new nt(i.x,i.y),o=new ot(r.pos.x,r.pos.y,this.canvas),a=[new U(0,"#00A2FF"),new U(1,"#FF9900")];return{player:r,camera:o,walls:s,portals:a}}mergeBlocks(t,e){const s=[],i=new Set,r=Array.from(t.keys()).sort((o,a)=>a-o);for(const o of r){const a=t.get(o);if(!a)continue;const c=Array.from(a.keys()).sort((l,p)=>l-p);for(const l of c){const p=`${l},${o}`;if(i.has(p))continue;const w=a.get(l);let g=0;for(;;){const y=l+g,f=a.get(y),v=`${y},${o}`;if(f===w&&!i.has(v))g++;else break}if(g===0)continue;let m=1;for(;;){const y=o-m,f=t.get(y);if(!f)break;let v=!0;for(let x=0;x<g;x++){const E=l+x,L=`${E},${y}`;if(f.get(E)!==w||i.has(L)){v=!1;break}}if(!v)break;m++}for(let y=0;y<m;y++)for(let f=0;f<g;f++)i.add(`${l+f},${o-y}`);s.push({x:l*e,y:(o-(m-1))*e,w:g*e,h:m*e,type:w})}}return s}}class ft{constructor(){this.ctx=null,this.ambienceNode=null,this.gainNode=null,this.initialized=!1}init(){if(this.initialized)return;const t=window.AudioContext||window.webkitAudioContext;this.ctx=new t,this.initialized=!0,this.startAmbience()}startAmbience(){const t=()=>{if(!this.initialized)return;const e=15+Math.random()*10,s=30,i=this.ctx.currentTime,r=[55,65.41,73.42,82.41,48],o=r[Math.floor(Math.random()*r.length)],a=Math.random()*15+5,c=150+Math.random()*200,l=this.ctx.createGain();l.connect(this.ctx.destination);const p=4,w=5;l.gain.setValueAtTime(0,i),l.gain.linearRampToValueAtTime(.15,i+p),l.gain.setValueAtTime(.15,i+e-w),l.gain.linearRampToValueAtTime(0,i+e);const g=this.ctx.createOscillator();g.type=Math.random()>.5?"sine":"triangle",g.frequency.value=o,g.connect(l),g.start(i),g.stop(i+e);const m=this.ctx.createOscillator();m.type="sine",m.frequency.value=o,m.detune.value=a,m.connect(l),m.start(i),m.stop(i+e);const y=this.ctx.createOscillator();y.type="sawtooth",y.frequency.value=o*2;const f=this.ctx.createBiquadFilter();f.type="lowpass",f.frequency.value=c;const v=this.ctx.createOscillator();v.type="sine",v.frequency.value=.1+Math.random()*.1;const x=this.ctx.createGain();x.gain.value=50,v.connect(x),x.connect(f.frequency),v.start(i),v.stop(i+e),y.connect(f),f.connect(l),y.start(i),y.stop(i+e),setTimeout(t,(e+s)*1e3)};t()}playShoot(t){if(!this.initialized)return;const e=this.ctx.createOscillator(),s=this.ctx.createGain();e.type="triangle";const i=this.ctx.currentTime;e.frequency.setValueAtTime(800,i),e.frequency.exponentialRampToValueAtTime(100,i+.15),s.gain.setValueAtTime(.75,i),s.gain.exponentialRampToValueAtTime(.001,i+.15),e.connect(s),s.connect(this.ctx.destination),e.start(i),e.stop(i+.15)}playLand(){if(!this.initialized)return;const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="sine";const s=this.ctx.currentTime;t.frequency.setValueAtTime(200,s),t.frequency.exponentialRampToValueAtTime(50,s+.2),e.gain.setValueAtTime(.75,s),e.gain.exponentialRampToValueAtTime(.001,s+.2),t.connect(e),e.connect(this.ctx.destination),t.start(s),t.stop(s+.2)}}class pt{constructor(t=50){this.undoStack=[],this.redoStack=[],this.limit=t}push(t){this.undoStack.push(t),this.undoStack.length>this.limit&&this.undoStack.shift(),this.redoStack=[]}undo(){if(this.undoStack.length===0)return;const t=this.undoStack.pop();t.undo(),this.redoStack.push(t)}redo(){if(this.redoStack.length===0)return;const t=this.redoStack.pop();t.redo(),this.undoStack.push(t)}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}clear(){this.undoStack=[],this.redoStack=[]}}class gt{constructor(t){this.history=t,this.width=100,this.height=100,this.blockSize=d.BLOCK_SIZE,this.layers=[],this.nextLayerId=1,this.activeLayerId=null,this.entities=new Map,this.addLayer("Layer 1")}addLayer(t){const e=this.nextLayerId++,s={id:e,name:t||`Layer ${e}`,visible:!0,data:new Map};return this.layers.push(s),this.activeLayerId=e,s}getActiveLayer(){return this.layers.find(t=>t.id===this.activeLayerId)}setActiveLayer(t){this.layers.find(s=>s.id===t)&&(this.activeLayerId=t)}toggleLayerVisibility(t){const e=this.layers.find(s=>s.id===t);e&&(e.visible=!e.visible)}placeBlock(t,e,s){const i=this.getActiveLayer();if(!i||!i.visible)return;const r=`${t},${e}`,o=i.data.get(r);o!==s&&(s===null?i.data.delete(r):i.data.set(r,s),this.history.push({undo:()=>{o==null?i.data.delete(r):i.data.set(r,o)},redo:()=>{s===null?i.data.delete(r):i.data.set(r,s)}}))}placeEntity(t,e,s){const i=`${t},${e}`,r=this.entities.get(i);if(r&&r.type===s)return;const o=s?{type:s,x:t,y:e}:null;o?this.entities.set(i,o):this.entities.delete(i),this.history.push({undo:()=>{r?this.entities.set(i,r):this.entities.delete(i)},redo:()=>{o?this.entities.set(i,o):this.entities.delete(i)}})}getBlock(t,e,s){const i=this.layers.find(r=>r.id===t);return i?i.data.get(`${e},${s}`):null}clear(){const t=JSON.parse(JSON.stringify(this.serialize().layers)),e=Array.from(this.entities.entries());this.layers=[],this.nextLayerId=1,this.entities.clear(),this.addLayer("Layer 1"),this.history.push({undo:()=>{this.deserialize({layers:t,entities:e})},redo:()=>{this.layers=[],this.nextLayerId=1,this.entities.clear(),this.addLayer("Layer 1")}})}serialize(){const t=this.layers.map(s=>({id:s.id,name:s.name,visible:s.visible,data:Array.from(s.data.entries())})),e=Array.from(this.entities.entries());return{width:this.width,height:this.height,blockSize:this.blockSize,layers:t,entities:e}}deserialize(t){t.layers&&(this.layers=t.layers.map(e=>({id:e.id,name:e.name,visible:e.visible,data:new Map(e.data)})),this.nextLayerId=Math.max(...this.layers.map(e=>e.id))+1,this.activeLayerId=this.layers[0].id),t.entities&&(this.entities=new Map(t.entities))}}class wt{constructor(t,e){this.canvas=t,this.ctx=t.getContext("2d"),this.levelManager=e,this.zoom=1,this.offsetX=0,this.offsetY=0,this.colors={1:"#888",2:"#00A2FF",3:"#FF5500"}}resize(){this.canvas.width=this.canvas.parentElement.clientWidth,this.canvas.height=this.canvas.parentElement.clientHeight,this.draw()}screenToGrid(t,e){const s=(t-this.offsetX)/this.zoom,i=(e-this.offsetY)/this.zoom,r=Math.floor(s/d.BLOCK_SIZE),o=Math.floor(i/d.BLOCK_SIZE);return{x:r,y:o}}draw(){const t=this.ctx,e=this.canvas.width,s=this.canvas.height;t.fillStyle=d.EDITOR_BG_COLOR,t.fillRect(0,0,e,s),t.save(),t.translate(this.offsetX,this.offsetY),t.scale(this.zoom,this.zoom),this.drawGrid(e,s),this.drawLayers(),this.drawEntities(),t.restore()}drawGrid(t,e){const s=this.ctx,i=d.BLOCK_SIZE,r=this.levelManager.width*i,o=this.levelManager.height*i;s.fillStyle="#222",s.fillRect(0,0,r,o),s.beginPath(),s.strokeStyle=d.EDITOR_GRID_COLOR,s.lineWidth=1/this.zoom;for(let a=0;a<=this.levelManager.width;a++)s.moveTo(a*i,0),s.lineTo(a*i,o);for(let a=0;a<=this.levelManager.height;a++)s.moveTo(0,a*i),s.lineTo(r,a*i);s.stroke(),s.beginPath(),s.strokeStyle="#444",s.moveTo(0,0),s.lineTo(r,0),s.moveTo(0,0),s.lineTo(0,o),s.stroke()}drawLayers(){const t=this.ctx,e=d.BLOCK_SIZE,s=this.levelManager.activeLayerId;for(const i of this.levelManager.layers)if(i.visible){t.globalAlpha=i.id===s?1:.5;for(const[r,o]of i.data.entries()){const[a,c]=r.split(",").map(Number),l=this.colors[o]||"#f0f";t.fillStyle=l,t.fillRect(a*e,c*e,e,e)}}t.globalAlpha=1}drawEntities(){const t=this.ctx,e=d.BLOCK_SIZE;for(const[s,i]of this.levelManager.entities.entries()){const[r,o]=s.split(",").map(Number),a=r*e,c=o*e,l=a+e/2,p=c+e/2;i.type==="spawn"?(t.fillStyle="#0f0",t.fillRect(a+2,c+2,e-4,e-4)):i.type==="health"?(t.fillStyle="#f00",t.fillRect(l-2,c+4,4,e-8),t.fillRect(a+4,p-2,e-8,4)):i.type==="coin"&&(t.fillStyle="#ff0",t.beginPath(),t.arc(l,p,e/3,0,Math.PI*2),t.fill())}}pan(t,e){this.offsetX+=t,this.offsetY+=e,this.draw()}setZoom(t){return this.zoom,this.zoom*=1+t*.1,this.zoom=Math.max(.1,Math.min(5,this.zoom)),this.draw(),this.zoom}}class vt{constructor(){this.canvas=document.getElementById("editor-canvas"),this.history=new pt,this.levelManager=new gt(this.history),this.renderer=new wt(this.canvas,this.levelManager),this.activeTool="brush",this.activeBlock=1,this.activeEntity=null,this.isDrawing=!1,this.isPanning=!1,this.lastMouseX=0,this.lastMouseY=0,this.init()}init(){this.bindEvents(),this.renderer.resize(),window.addEventListener("resize",()=>this.renderer.resize()),this.updateUI()}bindEvents(){this.canvas.addEventListener("mousedown",t=>this.onMouseDown(t)),this.canvas.addEventListener("mousemove",t=>this.onMouseMove(t)),this.canvas.addEventListener("mouseup",t=>this.onMouseUp(t)),this.canvas.addEventListener("mouseleave",t=>this.onMouseUp(t)),this.canvas.addEventListener("wheel",t=>this.onWheel(t)),window.addEventListener("keydown",t=>{t.key===" "?this.isPanning||(this.prevTool=this.activeTool,this.setTool("pan")):t.key.toLowerCase()==="b"?this.setTool("brush"):t.key.toLowerCase()==="e"?this.setTool("eraser"):(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="z"?(t.preventDefault(),this.history.undo(),this.renderer.draw()):(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="y"&&(t.preventDefault(),this.history.redo(),this.renderer.draw())}),window.addEventListener("keyup",t=>{t.key===" "&&this.prevTool&&(this.setTool(this.prevTool),this.prevTool=null)})}onMouseDown(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;this.lastMouseX=s,this.lastMouseY=i,this.activeTool==="pan"||t.button===1?(this.isPanning=!0,this.canvas.style.cursor="grabbing"):t.button===0&&(this.isDrawing=!0,this.useTool(s,i))}onMouseMove(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,r=this.renderer.screenToGrid(s,i);if(document.getElementById("status-coords").textContent=`${r.x}, ${r.y}`,this.isPanning){const o=s-this.lastMouseX,a=i-this.lastMouseY;this.renderer.pan(o,a)}else this.isDrawing&&(this.useTool(s,i),this.renderer.draw());this.lastMouseX=s,this.lastMouseY=i}onMouseUp(t){this.isDrawing=!1,this.isPanning=!1,this.activeTool==="pan"?this.canvas.style.cursor="grab":this.canvas.style.cursor="crosshair"}onWheel(t){t.preventDefault();const e=-Math.sign(t.deltaY),s=this.renderer.setZoom(e);document.getElementById("status-zoom").textContent=Math.round(s*100)+"%"}useTool(t,e){const{x:s,y:i}=this.renderer.screenToGrid(t,e);s<0||i<0||s>=this.levelManager.width||i>=this.levelManager.height||(this.activeTool==="brush"?this.activeEntity?this.levelManager.placeEntity(s,i,this.activeEntity):this.levelManager.placeBlock(s,i,this.activeBlock):this.activeTool==="eraser"&&(this.levelManager.placeBlock(s,i,null),this.levelManager.placeEntity(s,i,null)))}setTool(t){this.activeTool=t,document.querySelectorAll(".tool-btn").forEach(s=>s.classList.remove("active"));const e=document.getElementById(`tool-${t}`);e&&e.classList.add("active"),this.canvas.style.cursor=t==="pan"?"grab":"crosshair"}setBlock(t){var e;this.activeBlock=t,this.activeEntity=null,this.activeTool="brush",this.setTool("brush"),document.querySelectorAll(".palette-item").forEach(s=>s.classList.remove("active")),(e=document.querySelector(`.palette-item[data-type="${t}"]`))==null||e.classList.add("active"),document.querySelectorAll(".entity-item").forEach(s=>s.classList.remove("active"))}setEntity(t){var e;this.activeEntity=t,this.activeBlock=null,this.activeTool="brush",this.setTool("brush"),document.querySelectorAll(".palette-item").forEach(s=>s.classList.remove("active")),document.querySelectorAll(".entity-item").forEach(s=>s.classList.remove("active")),(e=document.querySelector(`.entity-item[data-type="${t}"]`))==null||e.classList.add("active")}addLayer(){this.levelManager.addLayer(),this.updateLayerList()}updateLayerList(){const t=document.getElementById("layer-list");t.innerHTML="",[...this.levelManager.layers].reverse().forEach(e=>{const s=document.createElement("div");s.className=`layer-item ${e.id===this.levelManager.activeLayerId?"active":""}`,s.onclick=()=>{this.levelManager.setActiveLayer(e.id),this.updateLayerList(),this.renderer.draw(),document.getElementById("status-layer").textContent=e.name};const i=document.createElement("span");i.className="layer-visibility",i.textContent=e.visible?"ðŸ‘ï¸":"â—‹",i.onclick=o=>{o.stopPropagation(),this.levelManager.toggleLayerVisibility(e.id),this.updateLayerList(),this.renderer.draw()};const r=document.createElement("span");r.textContent=e.name,s.appendChild(i),s.appendChild(r),t.appendChild(s)})}updateUI(){this.updateLayerList()}}let G=null;function xt(){if(G){G.updateUI(),G.renderer.draw();return}const n=new vt;G=n,document.getElementById("tool-brush").onclick=()=>n.setTool("brush"),document.getElementById("tool-eraser").onclick=()=>n.setTool("eraser"),document.getElementById("tool-pan").onclick=()=>n.setTool("pan"),document.querySelectorAll(".palette-item").forEach(t=>{t.onclick=()=>{document.querySelectorAll(".palette-item").forEach(s=>s.classList.remove("active")),t.classList.add("active");const e=parseInt(t.getAttribute("data-type"));n.setBlock(e)}}),document.querySelectorAll(".entity-item").forEach(t=>{t.onclick=()=>{document.querySelectorAll(".entity-item").forEach(s=>s.classList.remove("active")),t.classList.add("active");const e=t.getAttribute("data-type");n.setEntity(e)}}),document.getElementById("add-layer-btn").onclick=()=>n.addLayer(),document.getElementById("menu-clear").onclick=()=>{confirm("Are you sure you want to clear the level? All unsaved changes will be lost.")&&(n.levelManager.clear(),n.updateUI(),n.renderer.draw())},document.getElementById("menu-save").onclick=()=>{const t=n.levelManager.serialize(),e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(e),i=document.createElement("a");i.href=s,i.download="level.json",i.click(),URL.revokeObjectURL(s)},document.getElementById("menu-load").onclick=()=>{const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=e=>{const s=e.target.files[0];if(!s)return;const i=new FileReader;i.onload=r=>{try{const o=JSON.parse(r.target.result);n.levelManager.deserialize(o),n.updateUI(),n.renderer.draw()}catch(o){alert("Failed to load level: "+o.message)}},i.readAsText(s)},t.click()},document.getElementById("menu-export").onclick=()=>{const t=n.levelManager.serialize();navigator.clipboard.writeText(JSON.stringify(t,null,2)).then(()=>{alert("Level data copied to clipboard! You can paste it into the game's Load Level feature.")}).catch(e=>{console.error("Failed to copy:",e),alert("Failed to copy to clipboard. Use Save Level instead.")})},document.getElementById("menu-undo").onclick=()=>{n.history.undo(),n.renderer.draw()},document.getElementById("menu-redo").onclick=()=>{n.history.redo(),n.renderer.draw()},document.getElementById("menu-grid").onclick=()=>{n.renderer.draw()},document.getElementById("menu-reset-view").onclick=()=>{n.renderer.zoom=1,n.renderer.offsetX=0,n.renderer.offsetY=0,n.renderer.draw()},n.updateUI()}const C=document.getElementById("gameCanvas"),J=document.getElementById("game-container"),h=C.getContext("2d");let N;const K=new ft;let T,D,B=[],k=[],Y=[],F=[],_=!1,X=!0;function Et(n,t,e){k[n].active=!0,k[n].pos=t,k[n].normal=e,k[n].width=d.PORTAL_WIDTH}function q(){if(X)return;_=!_;const n=document.getElementById("ui");_?n.classList.add("paused"):n.classList.remove("paused")}function Mt(){console.log("startGame called"),X=!1;const n=document.getElementById("main-menu");n&&n.classList.add("hidden"),K.init(),j(),console.log("Game started, inMenu:",X)}function Q(){const n=1.7777777777777777;let t=window.innerWidth,e=window.innerHeight;t/e>n?t=e*n:e=t/n,J.style.width=t+"px",J.style.height=e+"px",C.width=t,C.height=e}function Lt(n){const e=new mt(C).instantiate(n);T=e.player,D=e.camera,B=e.walls,k=e.portals,F=[],Y=[]}function j(){T=new nt(300,I-100),D=new ot(T.pos.x,T.pos.y,C),k=[new U(0,"#00A2FF"),new U(1,"#FF9900")],B=[{x:0,y:0,w:R,h:40},{x:0,y:I-40,w:R,h:40},{x:0,y:0,w:40,h:I},{x:R-40,y:0,w:40,h:I},{x:200,y:I-250,w:200,h:20},{x:700,y:I-500,w:40,h:500},{x:800,y:300,w:400,h:40},{x:150,y:400,w:150,h:20},{x:R-400,y:I-150,w:60,h:110},{x:R-340,y:I-250,w:60,h:210},{x:R-280,y:I-350,w:60,h:310}]}function St(){Q(),window.addEventListener("resize",Q),N=new yt,N.init(C),N.onShootBluePortal=()=>{_||tt(0)},N.onShootOrangePortal=()=>{_||tt(1)};const n=()=>{K.init(),window.removeEventListener("keydown",n),window.removeEventListener("mousedown",n),window.removeEventListener("click",n)};window.addEventListener("keydown",n),window.addEventListener("mousedown",n),window.addEventListener("click",n),window.addEventListener("keydown",i=>{i.key.toLowerCase()==="escape"&&(i.preventDefault(),i.stopPropagation(),q(),_&&N.clearInput())}),window.addEventListener("contextmenu",i=>i.preventDefault()),document.getElementById("resumeBtn").addEventListener("click",()=>{_&&q()}),document.getElementById("resetBtn").addEventListener("click",()=>{j(),_&&q()}),document.getElementById("loadLevelBtn").addEventListener("click",()=>{const i=document.createElement("input");i.type="file",i.accept=".json",i.onchange=r=>{const o=r.target.files[0];if(!o)return;const a=new FileReader;a.onload=c=>{try{const l=JSON.parse(c.target.result);Lt(l),_&&q()}catch(l){alert("Failed to load level: "+l.message)}},a.readAsText(o)},i.click()});const t=document.getElementById("editor-overlay"),e=document.getElementById("game-container");document.getElementById("editorBtn").addEventListener("click",()=>{t.classList.add("active"),e.style.display="none",xt()}),document.getElementById("back-to-game-btn").addEventListener("click",()=>{t.classList.remove("active"),e.style.display="flex"});const s=document.getElementById("startBtn");s?(s.addEventListener("click",Mt),console.log("Start button event listener added")):console.error("Start button not found!"),j(),requestAnimationFrame(rt)}function tt(n){const t=N.getInputState(),e=new u(t.mouseX,t.mouseY),s=D.screenToWorld(e,C),i=new u(T.pos.x+T.size/2,T.pos.y+T.size/2),r=s.sub(i).normalize();let o=i.add(r.mult(d.PORTAL_ANCHOR_DISTANCE));it(o,B)&&(o=i),F.push(new ut(o,r,k[n].color,n)),K.playShoot()}function Tt(){const n=document.getElementById("editor-overlay");if(_||X||n.classList.contains("active"))return;const t=N.getInputState();T.update(t,B,k);const e=new u(t.mouseX,t.mouseY),s=T.getGhostPos(k),i=ht.calculate(B,k,T,d.CAM_BOUNDARY_PADDING);D.follow(T.getCenter(),e,C,s,k,t.spaceHeld,i);for(let r=F.length-1;r>=0;r--)F[r].update(B,Et,Y,K)||F.splice(r,1);for(let r=Y.length-1;r>=0;r--){let o=Y[r];o.pos=o.pos.add(o.vel),o.life--,o.life<=0&&Y.splice(r,1)}}function It(n,t,e,s){const i=t.width/e.zoom/2,r=t.height/e.zoom/2;e.pos.x-i,e.pos.x+i,e.pos.y-r,e.pos.y+r;const o=20,a=30;for(let c of s){if(!c.active)continue;const l=c.pos.x,p=c.pos.y,w=t.width/2,g=t.height/2,m=w+(l-e.pos.x)*e.zoom,y=g+(p-e.pos.y)*e.zoom;if(!(m<0||m>t.width||y<0||y>t.height))continue;const v=o,x=t.width-o,E=o,L=t.height-o;let S=Math.max(v,Math.min(x,m)),b=Math.max(E,Math.min(L,y)),O=Math.atan2(y-b,m-S);n.save(),n.translate(S,b),n.rotate(O);const M=c.color,A=parseInt(M.slice(1,3),16),P=parseInt(M.slice(3,5),16),z=parseInt(M.slice(5,7),16);n.fillStyle=`rgba(${A}, ${P}, ${z}, 0.4)`,n.strokeStyle=c.color,n.lineWidth=3,n.beginPath(),n.moveTo(a,0),n.lineTo(-a/2,-a/2),n.lineTo(-a/2,a/2),n.closePath(),n.fill(),n.stroke(),n.shadowBlur=15,n.shadowColor=c.color,n.fill(),n.shadowBlur=0,n.restore()}}function Ot(n,t,e,s){const i=t.width/e.zoom/2,r=t.height/e.zoom/2,o=e.pos.x-i,a=e.pos.x+i,c=e.pos.y-r,l=e.pos.y+r,p=s.getCenter(),w=p.x,g=p.y;if(!(w<o||w>a||g<c||g>l))return;const y=20,f=35,v=t.width/2,x=t.height/2,E=v+(w-e.pos.x)*e.zoom,L=x+(g-e.pos.y)*e.zoom,S=y,b=t.width-y,O=y,M=t.height-y;let A=Math.max(S,Math.min(b,E)),P=Math.max(O,Math.min(M,L)),z=Math.atan2(L-P,E-A);n.save(),n.translate(A,P),n.rotate(z),n.fillStyle="rgba(255, 255, 255, 0.4)",n.strokeStyle="#fff",n.lineWidth=3,n.beginPath(),n.moveTo(f,0),n.lineTo(-f/2,-f/2),n.lineTo(-f/2,f/2),n.closePath(),n.fill(),n.stroke(),n.shadowBlur=20,n.shadowColor="#fff",n.fill(),n.shadowBlur=0,n.restore()}function bt(){if(!document.getElementById("editor-overlay").classList.contains("active")){h.fillStyle="#000",h.fillRect(0,0,C.width,C.height),h.save(),D.apply(h,C),h.fillStyle="#222",h.fillRect(0,0,R,I),h.strokeStyle="#333",h.lineWidth=1,h.beginPath();for(let t=0;t<=R;t+=100)h.moveTo(t,0),h.lineTo(t,I);for(let t=0;t<=I;t+=100)h.moveTo(0,t),h.lineTo(R,t);h.stroke(),h.fillStyle="#444";for(let t of B)h.fillRect(t.x,t.y,t.w,t.h),h.strokeStyle="#555",h.lineWidth=2,h.strokeRect(t.x,t.y,t.w,t.h);for(let t of k)t.active&&(h.save(),h.translate(t.pos.x,t.pos.y),h.rotate(t.getAngle()),h.shadowBlur=20,h.shadowColor=t.color,h.fillStyle=t.color,h.fillRect(0,-t.width/2,4,t.width),h.fillStyle="#000",h.fillRect(-2,-t.width/2+2,2,t.width-4),h.restore());for(let t of F)t.draw(h);if(!X){const t=N.getInputState(),e=new u(t.mouseX,t.mouseY),s=D.screenToWorld(e,C),i=new u(T.pos.x+T.size/2,T.pos.y+T.size/2),r=s.sub(i).normalize();let o=i.add(r.mult(d.PORTAL_ANCHOR_DISTANCE));it(o,B)&&(o=i);const a=st(o,r,B),c=a?a.pos:o.add(r.mult(5e3));h.beginPath(),h.strokeStyle="rgba(255, 255, 255, 0.1)",h.lineWidth=2,h.moveTo(o.x,o.y),h.lineTo(c.x,c.y),h.stroke(),h.beginPath(),h.arc(s.x,s.y,5,0,Math.PI*2),h.strokeStyle="#fff",h.stroke()}for(let t of Y)h.fillStyle=t.color,h.fillRect(t.pos.x,t.pos.y,3,3);X||T.draw(h,k),h.restore(),X||(It(h,C,D,k),Ot(h,C,D,T))}}let W=0,Z=0;const et=1/60;function rt(n){W||(W=n);let t=(n-W)/1e3;for(W=n,t>.1&&(t=.1),Z+=t;Z>=et;)Tt(),Z-=et;bt(),requestAnimationFrame(rt)}St();</script>
</head>
<body>

<!-- Game Container -->
<div id="game-container">
    <!-- Main Menu -->
    <div id="main-menu">
        <div class="menu-box">
            <h1>Portal 2d</h1>
            <div class="subtitle">(demo)</div>
            <div class="controls">
                <p><span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span> to Move & Jump</p>
                <p><span class="key">Q</span> Shoot Blue Portal</p>
                <p><span class="key">E</span> Shoot Orange Portal</p>
                <p><span class="key">Space</span> Hold to View Portals</p>
                                <p><span class="key">Esc</span>Pause Menu</p>
            </div>
            <button id="startBtn" class="start-btn">START GAME</button>
        </div>
    </div>

    <!-- Pause UI -->
    <div id="ui">
        <div class="pause-menu">
            <h1>PAUSED</h1>
        <div class="controls">
            <p><span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span> to Move & Jump</p>
                <p><span class="key">Q</span> Shoot Blue Portal</p>
                <p><span class="key">E</span> Shoot Orange Portal</p>
            <p><span class="key">Space</span> Hold to View Portals</p>
                <p><span class="key">ESC</span> to Resume</p>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                <button id="resumeBtn">RESUME</button>
                <button id="resetBtn">RESET</button>
                <button id="loadLevelBtn">LOAD LEVEL</button>
                <button id="editorBtn" style="background: #FF5500;">LEVEL EDITOR</button>
            </div>
        </div>
    </div>
    <canvas id="gameCanvas" tabindex="0"></canvas>
</div>

<!-- Editor Overlay -->
<div id="editor-overlay">
    <!-- Menubar -->
    <div id="menubar">
        <div class="menu-item">
            File
            <div class="dropdown">
                <div class="dropdown-item" id="menu-clear">Clear Level</div>
                <div class="dropdown-item" id="menu-save">Save Level (JSON)</div>
                <div class="dropdown-item" id="menu-load">Load Level</div>
                <div class="dropdown-item" id="menu-export">Export for Game</div>
            </div>
        </div>
        <div class="menu-item">
            Edit
            <div class="dropdown">
                <div class="dropdown-item" id="menu-undo">Undo (Ctrl+Z)</div>
                <div class="dropdown-item" id="menu-redo">Redo (Ctrl+Y)</div>
            </div>
        </div>
        <div class="menu-item">
            View
            <div class="dropdown">
                <div class="dropdown-item" id="menu-grid">Toggle Grid</div>
                <div class="dropdown-item" id="menu-reset-view">Reset View</div>
            </div>
        </div>
        <div style="flex:1"></div>
        <button id="back-to-game-btn">Back to Game</button>
        <div class="menu-item" style="color: #aaa; font-style: italic;">Portal 2D Editor</div>
    </div>

    <!-- Main Layout -->
    <div id="editor-layout">
        <!-- Sidebar -->
        <div id="sidebar">
            
            <!-- Tools -->
            <div class="sidebar-section">
                <h3>Tools</h3>
                <div class="tool-group">
                    <div class="tool-btn active" id="tool-brush" title="Brush (B)">Brush</div>
                    <div class="tool-btn" id="tool-eraser" title="Eraser (E)">Eraser</div>
                    <div class="tool-btn" id="tool-pan" title="Pan (Space)">Pan</div>
                </div>
            </div>

            <!-- Blocks -->
            <div class="sidebar-section">
                <h3>Blocks</h3>
                <div class="block-palette" id="block-palette">
                    <div class="palette-item active" data-type="1" title="Wall"></div>
                    <div class="palette-item" data-type="2" title="Water"></div>
                    <div class="palette-item" data-type="3" title="Fire"></div>
                </div>
            </div>

            <!-- Entities -->
            <div class="sidebar-section">
                <h3>Entities</h3>
                <div id="entity-palette">
                    <div class="entity-item" data-type="spawn">
                        <div class="entity-icon" style="background: #0f0"></div> Player Spawn
                    </div>
                    <div class="entity-item" data-type="health">
                        <div class="entity-icon" style="background: #f00"></div> Health Pack
                    </div>
                    <div class="entity-item" data-type="coin">
                        <div class="entity-icon" style="background: #ff0"></div> Coin
                    </div>
                </div>
            </div>

            <!-- Layers -->
            <div class="sidebar-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3>Layers</h3>
                    <button id="add-layer-btn" style="background:none; border:none; color:#fff; cursor:pointer;">+</button>
                </div>
                <div class="layer-list" id="layer-list">
                    <div class="layer-item active">
                        <span class="layer-visibility">ðŸ‘ï¸</span>
                        <span>Layer 1</span>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Canvas -->
        <div id="canvas-container">
            <canvas id="editor-canvas"></canvas>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="statusbar">
        <div id="status-coords">0, 0</div>
        <div id="status-layer">Layer 1</div>
        <div id="status-zoom">100%</div>
    </div>
</div>

</body>
</html>
